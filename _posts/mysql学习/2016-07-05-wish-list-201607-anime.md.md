---
layout: post
title: mysql编译以及使用trace跟踪查看数据库处理
category: dump
description: 南大通用mysql培训
---

#mysql编译
---
安装字符终端下屏幕控制的基本库

```
    yum install ncurses-devel -y  
```

安装成功  
```
Installed:ncurses-devel.x86_64 0:5.9-14.20130511.el7_4 Complete!  
```
---

安装cmake 

```
yum install -y gcc gcc-c++ make automake
yum install -y wget
wget http://www.cmake.org/files/v2.8/cmake-2.8.10.2.tar.gz
tar -zxvf cmake-2.8.10.2.tar.gz
cd cmake-2.8.10.2
./bootstrap
make && make install
```
---

解压缩mysql依赖的boost库
```
unzip boost.zip
```
---

准备编译mysql
```
cmake ../mysql-5.7.20 -DCMAKE_BUILD_TYPE=Debug -DWITH_BOOST=\<boost库文件夹地址\>
```
---

编译安装mysql
```
make -j 10 //启动十个线程并行编译
make install
```
---

初始化数据库
```
/usr/local/mysql/bin/mysqld --initialize-insecure
```

打出信息
```
2019-11-25T15:35:15.664904Z 0 [Warning] InnoDB: New log files created, LSN=45790
2019-11-25T15:35:15.874561Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.
2019-11-25T15:35:15.960735Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: 2db71295-0f99-11ea-81f3-525400b3fc1d.
2019-11-25T15:35:15.966273Z 0 [Warning] Gtid table is not ready to be used. Table 'mysql.gtid_executed' cannot be opened.
2019-11-25T15:35:15.967183Z 1 [Warning] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.
```

---
启动mysql服务
```
/usr/local/mysql/bin/mysqld &
```
启动的log
```
[root@VM_0_9_centos mysql-build]# 2019-11-25T15:36:11.926667Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).
2019-11-25T15:36:11.926798Z 0 [Note] --secure-file-priv is set to NULL. Operations related to importing and exporting data are disabled
2019-11-25T15:36:11.926854Z 0 [Note] /usr/local/mysql/bin/mysqld (mysqld 5.7.20-debug) starting as process 2144 ...
2019-11-25T15:36:11.931391Z 0 [ERROR] Fatal error: Please read "Security" section of the manual to find out how to run mysqld as root!

2019-11-25T15:36:11.931436Z 0 [ERROR] Aborting

2019-11-25T15:36:11.931461Z 0 [Note] Binlog end
2019-11-25T15:36:11.931686Z 0 [Note] /usr/local/mysql/bin/mysqld: Shutdown complete
```
启动错误 我枯了 加上了 --user=root 就好了(去掉&)
```
2019-11-25T15:42:00.918732Z 0 [Note] InnoDB: Loading buffer pool(s) from /var/lib/mysql/ib_buffer_pool
2019-11-25T15:42:00.927648Z 0 [Note] InnoDB: Buffer pool(s) load completed at 191125 23:42:00
2019-11-25T15:42:00.932203Z 0 [Note] Server hostname (bind-address): '*'; port: 3306
2019-11-25T15:42:00.932254Z 0 [Note] IPv6 is available.
2019-11-25T15:42:00.932267Z 0 [Note]   - '::' resolves to '::';
2019-11-25T15:42:00.932292Z 0 [Note] Server socket created on IP: '::'.
2019-11-25T15:42:00.968781Z 0 [Note] Event Scheduler: Loaded 0 events
2019-11-25T15:42:00.969248Z 0 [Note] /usr/local/mysql/bin/mysqld: ready for connections.
Version: '5.7.20-debug'  socket: '/var/lib/mysql/mysql.sock'  port: 3306  Source distribution
2019-11-25T15:42:00.969262Z 0 [Note] Executing 'SELECT * FROM INFORMATION_SCHEMA.TABLES;' to get a list of tables using the deprecated partition engine. You may use the startup option '--disable-partition-engine-check' to skip this check. 
2019-11-25T15:42:00.969267Z 0 [Note] Beginning of list of non-natively partitioned tables
2019-11-25T15:42:00.994032Z 0 [Note] End of list of non-natively partitioned tables
```
此时发现 socket 建立在/var/lib/mysql/mysql.sock上

---

启动客户端，并且连接到上面的sock文件上
```
/usr/local/mysql/bin/mysql -uroot --socket=/var/lib/mysql/mysql.sock
```
连接成功  至此 完成编译
```
Server version: 5.7.20-debug Source distribution

Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> 
```


#trace追踪
---

Variable_name                | Value
-|-
optimizer_trace              | enabled=off,one_line=off|
optimizer_trace_features     | greedy_search=on,range_optimizer=on,dynamic_range=on,|repeated_subselect=on
optimizer_trace_limit | 1|
optimizer_trace_max_mem_size | 16384|
optimizer_trace_offset       | -1|

---
trace的开关打开
 ```
 SET optimizer_trace="enabled=on";
 ```


查询一个表
 ```
 mysql> select * from x$session;
+--------+---------+----------------+------+---------+--------------+------+-------------------------+-------------------+----------+--------------+---------------+-----------+---------------+------------+-----------------+-----------+----------------------------------+------------------------+----------------+-----------+-------------------+--------+-------------+-----------+----------------+------+--------------+
| thd_id | conn_id | user           | db   | command | state        | time | current_statement       | statement_latency | progress | lock_latency | rows_examined | rows_sent | rows_affected | tmp_tables | tmp_disk_tables | full_scan | last_statement                   | last_statement_latency | current_memory | last_wait | last_wait_latency | source | trx_latency | trx_state | trx_autocommit | pid  | program_name |
+--------+---------+----------------+------+---------+--------------+------+-------------------------+-------------------+----------+--------------+---------------+-----------+---------------+------------+-----------------+-----------+----------------------------------+------------------------+----------------+-----------+-------------------+--------+-------------+-----------+----------------+------+--------------+
|     28 |       3 | root@localhost | NULL | Sleep   | NULL         | 2766 | NULL                    |              NULL |     NULL |            0 |             0 |         1 |             0 |          0 |               0 | NO        | select @@version_comment limit 1 |              252511000 |              0 | NULL      | NULL              | NULL   |        NULL | NULL      | NULL           | 3835 | mysql        |
|     29 |       4 | root@localhost | NULL | Sleep   | NULL         | 1750 | NULL                    |              NULL |     NULL |    518000000 |          1066 |         5 |             0 |          1 |               0 | YES       | show variables like '%trace%'    |             5948054000 |              0 | NULL      | NULL              | NULL   |        NULL | NULL      | NULL           | 6063 | mysql        |
|     30 |       5 | root@localhost | sys  | Query   | Sending data |    0 | select * from x$session |        8125581000 |     NULL |   4626000000 |             0 |         0 |             0 |          4 |               1 | YES       | NULL                             |                   NULL |              0 | NULL      | NULL              | NULL   |        NULL | NULL      | NULL           | 9609 | mysql        |
+--------+---------+----------------+------+---------+--------------+------+-------------------------+-------------------+----------+--------------+---------------+-----------+---------------+------------+-----------------+-----------+----------------------------------+------------------------+----------------+-----------+-------------------+--------+-------------+-----------+----------------+------+--------------+
3 rows in set (0.17 sec)
```

# select * FROM information_schema.OPTIMIZER_TRACE
```
+-------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------+-------------------------+
| QUERY                   | TRACE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | MISSING_BYTES_BEYOND_MAX_MEM_SIZE | INSUFFICIENT_PRIVILEGES |
+-------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------+-------------------------+
| select * from x$session | {
  "steps": [
    {
      "join_preparation": {
        "select#": 1,
        "steps": [
          {
            "join_preparation": {
              "select#": 2,
              "steps": [
                {
                  "join_preparation": {
                    "select#": 3,
                    "steps": [
                      {
                        "join_preparation": {
                          "select#": 4,
                          "steps": [
                            {
                              "expanded_query": "/* select#4 */ select `performance_schema`.`t`.`THREAD_ID` AS `thread_id`,if((`performance_schema`.`t`.`NAME` = 'thread/sql/one_connection'),concat(`performance_schema`.`t`.`PROCESSLIST_USER`,'@',`performance_schema`.`t`.`PROCESSLIST_HOST`),replace(`performance_schema`.`t`.`NAME`,'thread/','')) AS `user`,sum(`performance_schema`.`mt`.`CURRENT_COUNT_USED`) AS `current_count_used`,sum(`performance_schema`.`mt`.`CURRENT_NUMBER_OF_BYTES_USED`) AS `current_allocated`,ifnull((sum(`performance_schema`.`mt`.`CURRENT_NUMBER_OF_BYTES_USED`) / nullif(sum(`performance_schema`.`mt`.`CURRENT_COUNT_USED`),0)),0) AS `current_avg_alloc`,max(`performance_schema`.`mt`.`CURRENT_NUMBER_OF_BYTES_USED`) AS `current_max_alloc`,sum(`performance_schema`.`mt`.`SUM_NUMBER_OF_BYTES_ALLOC`) AS `total_allocated` from (`performance_schema`.`memory_summary_by_thread_by_event_name` `mt` join `performance_schema`.`threads` `t` on((`performance_schema`.`mt`.`THREAD_ID` = `performance_schema`.`t`.`THREAD_ID`))) group by `performance_schema`.`t`.`THREAD_ID`,if((`performance_schema`.`t`.`NAME` = 'thread/sql/one_connection'),concat(`performance_schema`.`t`.`PROCESSLIST_USER`,'@',`performance_schema`.`t`.`PROCESSLIST_HOST`),replace(`performance_schema`.`t`.`NAME`,'thread/','')) order by sum(`performance_schema`.`mt`.`CURRENT_NUMBER_OF_BYTES_USED`) desc"
                            }
                          ]
                        }
                      },
                      {
                        "view": {
                          "table": "`x$memory_by_thread_by_current_bytes` `mem`",
                          "select#": 4,
                          "materialized": true
                        }
                      },
                      {
                        "expanded_query": "/* select#3 */ select `performance_schema`.`pps`.`THREAD_ID` AS `thd_id`,`performance_schema`.`pps`.`PROCESSLIST_ID` AS `conn_id`,if((`performance_schema`.`pps`.`NAME` = 'thread/sql/one_connection'),concat(`performance_schema`.`pps`.`PROCESSLIST_USER`,'@',`performance_schema`.`pps`.`PROCESSLIST_HOST`),replace(`performance_schema`.`pps`.`NAME`,'thread/','')) AS `user`,`performance_schema`.`pps`.`PROCESSLIST_DB` AS `db`,`performance_schema`.`pps`.`PROCESSLIST_COMMAND` AS `command`,`performance_schema`.`pps`.`PROCESSLIST_STATE` AS `state`,`performance_schema`.`pps`.`PROCESSLIST_TIME` AS `time`,`performance_schema`.`pps`.`PROCESSLIST_INFO` AS `current_statement`,if(isnull(`performance_schema`.`esc`.`END_EVENT_ID`),`performance_schema`.`esc`.`TIMER_WAIT`,NULL) AS `statement_latency`,if(isnull(`performance_schema`.`esc`.`END_EVENT_ID`),round((100 * (`performance_schema`.`estc`.`WORK_COMPLETED` / `performance_schema`.`estc`.`WORK_ESTIMATED`)),2),NULL) AS `progress`,`performance_schema`.`esc`.`LOCK_TIME` AS `lock_latency`,`performance_schema`.`esc`.`ROWS_EXAMINED` AS `rows_examined`,`performance_schema`.`esc`.`ROWS_SENT` AS `rows_sent`,`performance_schema`.`esc`.`ROWS_AFFECTED` AS `rows_affected`,`performance_schema`.`esc`.`CREATED_TMP_TABLES` AS `tmp_tables`,`performance_schema`.`esc`.`CREATED_TMP_DISK_TABLES` AS `tmp_disk_tables`,if(((`performance_schema`.`esc`.`NO_GOOD_INDEX_USED` > 0) or (`performance_schema`.`esc`.`NO_INDEX_USED` > 0)),'YES','NO') AS `full_scan`,if((`performance_schema`.`esc`.`END_EVENT_ID` is not null),`performance_schema`.`esc`.`SQL_TEXT`,NULL) AS `last_statement`,if((`performance_schema`.`esc`.`END_EVENT_ID` is not null),`performance_schema`.`esc`.`TIMER_WAIT`,NULL) AS `last_statement_latency`,`mem`.`current_allocated` AS `current_memory`,`performance_schema`.`ewc`.`EVENT_NAME` AS `last_wait`,if((isnull(`performance_schema`.`ewc`.`END_EVENT_ID`) and (`performance_schema`.`ewc`.`EVENT_NAME` is not null)),'Still Waiting',`performance_schema`.`ewc`.`TIMER_WAIT`) AS `last_wait_latency`,`performance_schema`.`ewc`.`SOURCE` AS `source`,`performance_schema`.`etc`.`TIMER_WAIT` AS `trx_latency`,`performance_schema`.`etc`.`STATE` AS `trx_state`,`performance_schema`.`etc`.`AUTOCOMMIT` AS `trx_autocommit`,`performance_schema`.`conattr_pid`.`ATTR_VALUE` AS `pid`,`performance_schema`.`conattr_progname`.`ATTR_VALUE` AS `program_name` from (((((((`performance_schema`.`threads` `pps` left join `performance_schema`.`events_waits_current` `ewc` on((`performance_schema`.`pps`.`THREAD_ID` = `performance_schema`.`ewc`.`THREAD_ID`))) left join `performance_schema`.`events_stages_current` `estc` on((`performance_schema`.`pps`.`THREAD_ID` = `performance_schema`.`estc`.`THREAD_ID`))) left join `performance_schema`.`events_statements_current` `esc` on((`performance_schema`.`pps`.`THREAD_ID` = `performance_schema`.`esc`.`THREAD_ID`))) left join `performance_schema`.`events_transactions_current` `etc` on((`performance_schema`.`pps`.`THREAD_ID` = `performance_schema`.`etc`.`THREAD_ID`))) left join `x$memory_by_thread_by_current_bytes` `mem` on((`performance_schema`.`pps`.`THREAD_ID` = `mem`.`thread_id`))) left join `performance_schema`.`session_connect_attrs` `conattr_pid` on(((`performance_schema`.`conattr_pid`.`PROCESSLIST_ID` = `performance_schema`.`pps`.`PROCESSLIST_ID`) and (`performance_schema`.`conattr_pid`.`ATTR_NAME` = '_pid')))) left join `performance_schema`.`session_connect_attrs` `conattr_progname` on(((`performance_schema`.`conattr_progname`.`PROCESSLIST_ID` = `performance_schema`.`pps`.`PROCESSLIST_ID`) and (`performance_schema`.`conattr_progname`.`ATTR_NAME` = 'program_name')))) order by `performance_schema`.`pps`.`PROCESSLIST_TIME` desc,`last_wait_latency` desc"
                      }
                    ]
                  }
                },
                {
                  "view": {
                    "table": "`x$processlist`",
                    "select#": 3,
                    "materialized": true
                  }
                },
                {
                  "expanded_query": "/* select#2 */ select `x$processlist`.`thd_id` AS `thd_id`,`x$processlist`.`conn_id` AS `conn_id`,`x$processlist`.`user` AS `user`,`x$processlist`.`db` AS `db`,`x$processlist`.`command` AS `command`,`x$processlist`.`state` AS `state`,`x$processlist`.`time` AS `time`,`x$processlist`.`current_statement` AS `current_statement`,`x$processlist`.`statement_latency` AS `statement_latency`,`x$processlist`.`progress` AS `progress`,`x$processlist`.`lock_latency` AS `lock_latency`,`x$processlist`.`rows_examined` AS `rows_examined`,`x$processlist`.`rows_sent` AS `rows_sent`,`x$processlist`.`rows_affected` AS `rows_affected`,`x$processlist`.`tmp_tables` AS `tmp_tables`,`x$processlist`.`tmp_disk_tables` AS `tmp_disk_tables`,`x$processlist`.`full_scan` AS `full_scan`,`x$processlist`.`last_statement` AS `last_statement`,`x$processlist`.`last_statement_latency` AS `last_statement_latency`,`x$processlist`.`current_memory` AS `current_memory`,`x$processlist`.`last_wait` AS `last_wait`,`x$processlist`.`last_wait_latency` AS `last_wait_latency`,`x$processlist`.`source` AS `source`,`x$processlist`.`trx_latency` AS `trx_latency`,`x$processlist`.`trx_state` AS `trx_state`,`x$processlist`.`trx_autocommit` AS `trx_autocommit`,`x$processlist`.`pid` AS `pid`,`x$processlist`.`program_name` AS `program_name` from `x$processlist` where ((`x$processlist`.`conn_id` is not null) and (`x$processlist`.`command` <> 'Daemon'))"
                }
              ]
            }
          },
          {
            "view": {
              "table": "`x$session`",
              "select#": 2,
              "merged": true
            }
          },
          {
            "expanded_query": "/* select#1 */ select `x$processlist`.`thd_id` AS `thd_id`,`x$processlist`.`conn_id` AS `conn_id`,`x$processlist`.`user` AS `user`,`x$processlist`.`db` AS `db`,`x$processlist`.`command` AS `command`,`x$processlist`.`state` AS `state`,`x$processlist`.`time` AS `time`,`x$processlist`.`current_statement` AS `current_statement`,`x$processlist`.`statement_latency` AS `statement_latency`,`x$processlist`.`progress` AS `progress`,`x$processlist`.`lock_latency` AS `lock_latency`,`x$processlist`.`rows_examined` AS `rows_examined`,`x$processlist`.`rows_sent` AS `rows_sent`,`x$processlist`.`rows_affected` AS `rows_affected`,`x$processlist`.`tmp_tables` AS `tmp_tables`,`x$processlist`.`tmp_disk_tables` AS `tmp_disk_tables`,`x$processlist`.`full_scan` AS `full_scan`,`x$processlist`.`last_statement` AS `last_statement`,`x$processlist`.`last_statement_latency` AS `last_statement_latency`,`x$processlist`.`current_memory` AS `current_memory`,`x$processlist`.`last_wait` AS `last_wait`,`x$processlist`.`last_wait_latency` AS `last_wait_latency`,`x$processlist`.`source` AS `source`,`x$processlist`.`trx_latency` AS `trx_latency`,`x$processlist`.`trx_state` AS `trx_state`,`x$processlist`.`trx_autocommit` AS `trx_autocommit`,`x$processlist`.`pid` AS `pid`,`x$processlist`.`program_name` AS `program_name` from (`x$processlist`)"
          },
          {
            "transformations_to_nested_joins": {
              "transformations": [
                "JOIN_condition_to_WHERE",
                "parenthesis_removal"
              ],
              "expanded_query": "/* select#4 */ select `performance_schema`.`t`.`THREAD_ID` AS `thread_id`,if((`performance_schema`.`t`.`NAME` = 'thread/sql/one_connection'),concat(`performance_schema`.`t`.`PROCESSLIST_USER`,'@',`performance_schema`.`t`.`PROCESSLIST_HOST`),replace(`performance_schema`.`t`.`NAME`,'thread/','')) AS `user`,sum(`performance_schema`.`mt`.`CURRENT_COUNT_USED`) AS `current_count_used`,sum(`performance_schema`.`mt`.`CURRENT_NUMBER_OF_BYTES_USED`) AS `current_allocated`,ifnull((sum(`performance_schema`.`mt`.`CURRENT_NUMBER_OF_BYTES_USED`) / nullif(sum(`performance_schema`.`mt`.`CURRENT_COUNT_USED`),0)),0) AS `current_avg_alloc`,max(`performance_schema`.`mt`.`CURRENT_NUMBER_OF_BYTES_USED`) AS `current_max_alloc`,sum(`performance_schema`.`mt`.`SUM_NUMBER_OF_BYTES_ALLOC`) AS `total_allocated` from `performance_schema`.`memory_summary_by_thread_by_event_name` `mt` join `performance_schema`.`threads` `t` where (`performance_schema`.`mt`.`THREAD_ID` = `performance_schema`.`t`.`THREAD_ID`) group by `performance_schema`.`t`.`THREAD_ID`,if((`performance_schema`.`t`.`NAME` = 'thread/sql/one_connection'),concat(`performance_schema`.`t`.`PROCESSLIST_USER`,'@',`performance_schema`.`t`.`PROCESSLIST_HOST`),replace(`performance_schema`.`t`.`NAME`,'thread/','')) order by sum(`performance_schema`.`mt`.`CURRENT_NUMBER_OF_BYTES_USED`) desc"
            }
          },
          {
            "transformations_to_nested_joins": {
              "transformations": [
                "parenthesis_removal"
              ],
              "expanded_query": "/* select#3 */ select `performance_schema`.`pps`.`THREAD_ID` AS `thd_id`,`performance_schema`.`pps`.`PROCESSLIST_ID` AS `conn_id`,if((`performance_schema`.`pps`.`NAME` = 'thread/sql/one_connection'),concat(`performance_schema`.`pps`.`PROCESSLIST_USER`,'@',`performance_schema`.`pps`.`PROCESSLIST_HOST`),replace(`performance_schema`.`pps`.`NAME`,'thread/','')) AS `user`,`performance_schema`.`pps`.`PROCESSLIST_DB` AS `db`,`performance_schema`.`pps`.`PROCESSLIST_COMMAND` AS `command`,`performance_schema`.`pps`.`PROCESSLIST_STATE` AS `state`,`performance_schema`.`pps`.`PROCESSLIST_TIME` AS `time`,`performance_schema`.`pps`.`PROCESSLIST_INFO` AS `current_statement`,if(isnull(`performance_schema`.`esc`.`END_EVENT_ID`),`performance_schema`.`esc`.`TIMER_WAIT`,NULL) AS `statement_latency`,if(isnull(`performance_schema`.`esc`.`END_EVENT_ID`),round((100 * (`performance_schema`.`estc`.`WORK_COMPLETED` / `performance_schema`.`estc`.`WORK_ESTIMATED`)),2),NULL) AS `progress`,`performance_schema`.`esc`.`LOCK_TIME` AS `lock_latency`,`performance_schema`.`esc`.`ROWS_EXAMINED` AS `rows_examined`,`performance_schema`.`esc`.`ROWS_SENT` AS `rows_sent`,`performance_schema`.`esc`.`ROWS_AFFECTED` AS `rows_affected`,`performance_schema`.`esc`.`CREATED_TMP_TABLES` AS `tmp_tables`,`performance_schema`.`esc`.`CREATED_TMP_DISK_TABLES` AS `tmp_disk_tables`,if(((`performance_schema`.`esc`.`NO_GOOD_INDEX_USED` > 0) or (`performance_schema`.`esc`.`NO_INDEX_USED` > 0)),'YES','NO') AS `full_scan`,if((`performance_schema`.`esc`.`END_EVENT_ID` is not null),`performance_schema`.`esc`.`SQL_TEXT`,NULL) AS `last_statement`,if((`performance_schema`.`esc`.`END_EVENT_ID` is not null),`performance_schema`.`esc`.`TIMER_WAIT`,NULL) AS `last_statement_latency`,`mem`.`current_allocated` AS `current_memory`,`performance_schema`.`ewc`.`EVENT_NAME` AS `last_wait`,if((isnull(`performance_schema`.`ewc`.`END_EVENT_ID`) and (`performance_schema`.`ewc`.`EVENT_NAME` is not null)),'Still Waiting',`performance_schema`.`ewc`.`TIMER_WAIT`) AS `last_wait_latency`,`performance_schema`.`ewc`.`SOURCE` AS `source`,`performance_schema`.`etc`.`TIMER_WAIT` AS `trx_latency`,`performance_schema`.`etc`.`STATE` AS `trx_state`,`performance_schema`.`etc`.`AUTOCOMMIT` AS `trx_autocommit`,`performance_schema`.`conattr_pid`.`ATTR_VALUE` AS `pid`,`performance_schema`.`conattr_progname`.`ATTR_VALUE` AS `program_name` from `performance_schema`.`threads` `pps` left join `performance_schema`.`events_waits_current` `ewc` on((`performance_schema`.`pps`.`THREAD_ID` = `performance_schema`.`ewc`.`THREAD_ID`)) left join `performance_schema`.`events_stages_current` `estc` on((`performance_schema`.`pps`.`THREAD_ID` = `performance_schema`.`estc`.`THREAD_ID`)) left join `performance_schema`.`events_statements_current` `esc` on((`performance_schema`.`pps`.`THREAD_ID` = `performance_schema`.`esc`.`THREAD_ID`)) left join `performance_schema`.`events_transactions_current` `etc` on((`performance_schema`.`pps`.`THREAD_ID` = `performance_schema`.`etc`.`THREAD_ID`)) left join `x$memory_by_thread_by_current_bytes` `mem` on((`performance_schema`.`pps`.`THREAD_ID` = `mem`.`thread_id`)) left join `performance_schema`.`session_connect_attrs` `conattr_pid` on(((`performance_schema`.`conattr_pid`.`PROCESSLIST_ID` = `performance_schema`.`pps`.`PROCESSLIST_ID`) and (`performance_schema`.`conattr_pid`.`ATTR_NAME` = '_pid'))) left join `performance_schema`.`session_connect_attrs` `conattr_progname` on(((`performance_schema`.`conattr_progname`.`PROCESSLIST_ID` = `performance_schema`.`pps`.`PROCESSLIST_ID`) and (`performance_schema`.`conattr_progname`.`ATTR_NAME` = 'program_name'))) order by `performance_schema`.`pps`.`PROCESSLIST_TIME` desc,`last_wait_latency` desc |                             44115 |                       0 |
+-------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------+-------------------------+
```
