---
layout: post
title: mysql执行流程和数据结构
category: dump
description: 南大通用mysql培训
---

--- 
# mysql执行流程
## 1.初始化
## 2.命令分发（没有做语法解析）
## 3.命令解析（语法解析）
1.bison 通过 sql_yacc.yy 解析
2.sql_yacc.yy 可以编译成 .cc和.h文件
## 4.各种命令对应不同的模块
## 5.表的管理（数据一致性 加锁）
---

# 数据结构 THD
#### 对每个客户端的连接 重建一个线程（一个连接对应一个线程）
#### MDL元数据锁
#### query_arena查询工作的地方
#### open_table_state打开表的状态
## 线程内变量
```
user_vars :包含了用户的各种信息
m_db : 使用use语句 修改当前数据库变量
m_catalog: 当前的目录
```

# lex
## table_list
## select_(lex|unit)

# item

+ 与sql语句中的某个部分相关
+ 具有一个值
+ 具有一个数据类型描述符
+ 字面值 列引用 会话和全局变量 过程变量参数 sql函数

## 一个sql语句怎么表示的
+ main.unit 总的sql语句
+ fake0 表示假的数据指针（表达 limit和order by）
+ slave指针指向更小一层的select语句(可以找到所有的select语句)
+ master指针都指向main.unit

在数据库做一个自己的函数
#使用udf函数自定义函数
```
extern "C"
{
// str_reverse
my_bool str_trim_init(UDF_INIT* initid, UDF_ARGS* args, char* message);//初始化函数,
void str_trim_deinit(UDF_INIT* initid);//回收函数
char* str_trim(UDF_INIT* initid, UDF_ARGS* args, char* result, unsigned long* length, char* is_null, char *error);//使用的函数
}
char * StrData =0;
int gSum = 0;

my_bool str_trim_init(UDF_INIT* initid, UDF_ARGS* args, char* message){//定义初始化函数
    if (args->arg_count != 1){//控制输入变量
        strcpy(message,"input error shit");
        return 1;
    }
    if (args->arg_type[0] != STRING_RESULT)
    {
        strcpy(message,"please input string");
        return 1;
    }
    StrData = (char*)malloc(4096);//初始化变量
    memset(StrData,0,4096);
    initid->maybe_null =1;//初始化句柄中各种参数
    initid->max_length =32;
    initid->ptr = StrData;
    return 0;
}

void str_trim_deinit(UDF_INIT *initid){//回收函数
    free(StrData);
}

char* str_trim(UDF_INIT* initid, UDF_ARGS* args, char* result, unsigned long* length, char* is_null, char *error)//执行函数
{
    if (args->arg_type[0] == STRING_RESULT)
    {   
        strncpy(StrData, args->args[0], 4096);
        for (int a=0 ;a <strlen(StrData);a++){
            if( StrData[a]<'A'|| StrData[a]>'z'){
                StrData[a] ='_';
            }
        }
        strncat(StrData," func_kun",9);
        return StrData;
    }

    return NULL;
}
```

下一步 编译代码生成库文件
第一步 查看自己安装mysql开发版 没有安装使用下面命令安装
```
yum -y install mysql-devel
```
编译我们刚编写的文件
```
 g++ -I/usr/include/mysql -shared -fPIC -o udf_str.so mysql_udf.cc 
```
下一步 将编写好的库文件 放在我们的mysql 插件路径下
```
show variables like 'plugin_dir';
```
```
+---------------+------------------------------+
| Variable_name | Value                        |
+---------------+------------------------------+
| plugin_dir    | /usr/local/mysql/lib/plugin/ |
+---------------+------------------------------+
```
可以看到 我们的路径在 ```/usr/local/mysql/lib/plugin/``` 下
所以把刚编译好的so文件 放在这个路径下

在mysql cli中 我们使用``` create function str_trim RETURNS string SONAME 'udf_str.so';```创建mysql函数

创建好可以使用命令```select * from mysql.func;```查看
```
+----------+-----+------------+----------+
| name     | ret | dl         | type     |
+----------+-----+------------+----------+
| str_trim |   0 | udf_str.so | function |
+----------+-----+------------+----------+
```

到此为止 创建成功

---

执行函数
```
select str_trim("abc12abc");
```
```+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| str_trim("abc12abc")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| abc__abc func_kun                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
```